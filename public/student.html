<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Live Lecture ‚Äî Student</title>
  <style>
    body {
      margin: 0; padding: 1rem;
      background: #1e1e2f; color: #e0e0e0;
      font-family: 'Segoe UI', sans-serif;
      display: flex; flex-direction: column;
      align-items: center;
    }
    h1 { margin-bottom: 1rem; }

    #video-container {
      position: relative;
      width: 100%; max-width: 900px;
      background: #000; border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(0,0,0,0.6);
    }
    video {
      width: 100%; height: auto;
      background: #000;
    }

    /* Controls row */
    #controls {
      display: flex; align-items: center;
      justify-content: space-between;
      background: #2a2a3d;
      padding: 0.5rem;
      border-radius: 0 0 8px 8px;
      width: 100%;
      max-width: 900px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.6);
      margin-bottom: 1rem;
    }
    #controls > * { margin: 0 0.5rem; }

    button, select, input[type=range] {
      background: #444; color: #e0e0e0;
      border: none; border-radius: 4px;
      padding: 0.3rem 0.6rem;
      cursor: pointer; font-size: 0.9rem;
    }
    button:disabled {
      background: #222;
      cursor: not-allowed;
    }
    button:hover:not(:disabled), select:hover, input[type=range]:hover {
      background: #5c6bc0;
    }

    /* Chat styling */
    #chat {
      width: 100%; max-width: 900px;
      display: flex; flex-direction: column;
      background: #2a2a3d; border-radius:8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.6);
    }
    #messages {
      flex:1; padding:1rem; max-height:200px;
      overflow-y:auto; border-bottom:1px solid #3a3a52;
    }
    .msg { margin-bottom: 0.5rem; }
    .msg.admin   { color: #4fc3f7; }
    .msg.student { color: #81c784; }
    #chat-input {
      display:flex; padding:0.5rem;
    }
    #chatIn {
      flex:1; padding:0.6rem; font-size:1rem;
      border:none; border-radius:4px 0 0 4px;
      background:#1e1e2f; color:#e0e0e0;
    }
    #sendChat {
      border-radius:0 4px 4px 0; padding:0 1rem;
    }

    /* FPS badge */
    #fpsBadge {
      position: absolute; top: 8px; right: 8px;
      background: rgba(0,0,0,0.6); padding: 0.2rem 0.5rem;
      border-radius: 4px; font-size: 0.8rem;
      color: #fff;
    }
  </style>
</head>
<body>

  <h1>üéì Live Lecture</h1>

  <div id="video-container">
    <video id="video" autoplay playsinline muted></video>
    <div id="fpsBadge">FPS: --</div>
  </div>

  <!-- Custom controls -->
  <div id="controls">
    <button id="playPause">‚ñ∂Ô∏è</button>
    <button id="skipBack">‚üµ10s</button>
    <input type="range" id="seekBar" min="0" max="100" value="0">
    <button id="skipFwd">10s‚ü∂</button>
    <span id="timeDisplay">00:00 / 00:00</span>
    <select id="playbackRate">
      <option>0.5√ó</option>
      <option selected>1√ó</option>
      <option>1.25√ó</option>
      <option>1.5√ó</option>
      <option>2√ó</option>
    </select>
    <button id="fullscreen">‚õ∂</button>
  </div>

  <!-- Chat panel -->
  <div id="chat">
    <div id="messages"></div>
    <div id="chat-input">
      <input id="chatIn" placeholder="Type your question‚Ä¶" autocomplete="off">
      <button id="sendChat">Send</button>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    // ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî WebRTC Setup ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
    const socket = io();
    const ROOM = 'main-room';
    let pc;

    const iceConfig = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };

    socket.emit('join', ROOM);

    socket.on('offer', async data => {
      if (pc) pc.close();
      pc = new RTCPeerConnection(iceConfig);

      pc.ontrack = e => {
        video.srcObject = e.streams[0];
        video.play().catch(()=>{});
      };
      pc.onicecandidate = e => {
        if (e.candidate) {
          socket.emit('ice-candidate', {
            room: ROOM, to: data.from, candidate: e.candidate
          });
        }
      };

      await pc.setRemoteDescription(data.offer);
      const ans = await pc.createAnswer();
      await pc.setLocalDescription(ans);
      socket.emit('answer', { room: ROOM, to: data.from, answer: ans });
    });

    socket.on('ice-candidate', async data => {
      try { await pc.addIceCandidate(data.candidate); }
      catch(e){ console.warn('ICE failed', e); }
    });

    // ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî Video UI Logic ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
    const video       = document.getElementById('video');
    const playPause   = document.getElementById('playPause');
    const skipBack    = document.getElementById('skipBack');
    const skipFwd     = document.getElementById('skipFwd');
    const seekBar     = document.getElementById('seekBar');
    const timeDisplay = document.getElementById('timeDisplay');
    const rateSelect  = document.getElementById('playbackRate');
    const fullscreen  = document.getElementById('fullscreen');
    const fpsBadge    = document.getElementById('fpsBadge');

    // Disable skip until metadata arrives
    skipBack.disabled = true;
    skipFwd.disabled  = true;

    video.onloadedmetadata = () => {
      skipBack.disabled = false;
      skipFwd.disabled  = false;
    };

    // Play/Pause
    playPause.onclick = () => {
      if (video.paused) video.play();
      else              video.pause();
    };
    video.onplay  = () => playPause.textContent = '‚è∏Ô∏è';
    video.onpause = () => playPause.textContent = '‚ñ∂Ô∏è';

    // Seek bar & time
    video.ontimeupdate = () => {
      if (isFinite(video.duration)) {
        const val = (video.currentTime / video.duration) * 100;
        seekBar.value = val;
        timeDisplay.textContent = formatTime(video.currentTime) +
                                  ' / ' + formatTime(video.duration);
      }
    };
    seekBar.oninput = () => {
      if (isFinite(video.duration)) {
        video.currentTime = (seekBar.value / 100) * video.duration;
      }
    };

    // Skip buttons with guards
    skipBack.onclick = () => {
      if (!isFinite(video.currentTime)) return;
      video.currentTime = Math.max(0, video.currentTime - 10);
    };
    skipFwd.onclick = () => {
      if (!isFinite(video.currentTime) || !isFinite(video.duration)) return;
      video.currentTime = Math.min(video.duration, video.currentTime + 10);
    };

    // Playback rate
    rateSelect.onchange = () => {
      video.playbackRate = parseFloat(rateSelect.value);
    };

    // Fullscreen
    fullscreen.onclick = () => {
      const c = video.parentElement;
      if (document.fullscreenElement) document.exitFullscreen();
      else                            c.requestFullscreen();
    };

    function formatTime(sec) {
      if (isNaN(sec)) return '00:00';
      const m = Math.floor(sec / 60), s = Math.floor(sec % 60);
      return String(m).padStart(2, '0') + ':' + String(s).padStart(2, '0');
    }

    // ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî Chat ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
    document.getElementById('sendChat').onclick = () => {
      const txt = document.getElementById('chatIn');
      const msg = txt.value.trim();
      if (!msg) return;
      socket.emit('chat-message', { room: ROOM, message: 'Student: ' + msg });
      txt.value = '';
    };
    socket.on('chat-message', data => {
      const d = document.createElement('div');
      d.textContent = data.message;
      d.className = 'msg ' + (data.message.startsWith('Admin:') ? 'admin' : 'student');
      document.getElementById('messages').appendChild(d);
      document.getElementById('messages').scrollTop = 1e9;
    });

    // ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî FPS Monitor ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
    if ('requestVideoFrameCallback' in HTMLVideoElement.prototype) {
      let lastTime, frames = 0;
      function measure(now) {
        if (lastTime != null) {
          frames++;
          const delta = now - lastTime;
          if (delta >= 1000) {
            fpsBadge.textContent = 'FPS: ' + Math.round((frames * 1000) / delta);
            frames = 0;
            lastTime = now;
          }
        } else lastTime = now;
        video.requestVideoFrameCallback(measure);
      }
      video.requestVideoFrameCallback(measure);
    } else {
      fpsBadge.style.display = 'none';
    }
  </script>
</body>
</html>
